#
# This file is part of DataBallet.
# Copyright (C) 2012 Laurent Parenteau <laurent.parenteau@gmail.com>
#
##################################################################
#								#
# Copyright (c) 2017,2018 YottaDB LLC. and/or its subsidiaries.	#
# All rights reserved.						#
#								#
#	This source code contains the intellectual property	#
#	of its copyright holder(s), and is made available	#
#	under a license.  If you do not know the terms of	#
#	the license, please stop and do not read further.	#
#								#
#################################################################
#
# DataBallet is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# DataBallet is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with DataBallet. If not, see <http://www.gnu.org/licenses/>.
#



# Setup GT.M
#  Running path, containing M source code.
: ${gtmdir:="."}
export gtmdir
#  Version used
: ${gtmver:="r110"}
export gtmver
#  Install path
: ${gtm_dist:="/usr/local/lib/yottadb/$gtmver"}
export gtm_dist
#  Temporary directory
: ${gtm_tmp:="./tmp"}
export gtm_tmp
#  Log directory
: ${gtm_log:="$gtm_tmp"}
export gtm_log
#  Principal editing
: ${gtm_principal_editing:="EDITING"}
export gtm_principal_editing
#  Prompt
: ${gtm_prompt:="DataBallet>"}
export gtm_prompt
#  Global directory
gtmgbldir="$gtmdir/sample-glds/gtm.gld"
export gtmgbldir
#  M routines
#: ${gtmroutines:="$gtmdir/$gtmver/o*(/home/gtmuser/DataBallet-master/r $gtmdir/$gtmver/r $gtmdir/r) $gtm_dist/libgtmutil.so $gtm_dist"}
gtmroutines="$gtmdir/o($gtmdir/r) $gtm_dist/plugin/o($gtm_dist/plugin/r) $gtm_dist"
export gtmroutines
# Autorelink
: ${gtm_link:="recursive"}
export gtm_link
#  TLS Config
: ${gtmcrypt_config:="$gtmdir/conf/tls-conf.libconf"}
export gtmcrypt_config
: ${gtmtls_passwd_tls:="AAA"}
export gtmtls_passwd_tls

# Create directories, if needed
#mkdir -p $gtmdir/$gtmver/r $gtmdir/$gtmver/g $gtmdir/$gtmver/o $gtm_tmp $gtm_log
mkdir -p $gtmdir/r $gtmdir/o $gtm_tmp $gtm_log

# PID file location
#  Default value : With GT.M's log files.
export pid="$gtm_log/databallet.pid"

# SCRIPT log file location
#  Default value : With GT.M's log files.
export log="$gtm_log/databallet_script.log"

# DataBallet configuration
#cat > $gtmdir/$gtmver/r/userconf.m << EOF
#cat > /home/gtmuser/DataBallet-master/r/userconf.m << EOF
cat > $gtmdir/r/userconf.m << EOF
userconf;
	; Server string.
	;  Use "min" for "DataBallet", or "full" for "DataBallet-<version> (<$zversion>)" (ex. : "DataBallet-20120606 (GT.M V5.5-000 Linux x86)").
	;  Any other string will default to "min".
	set conf("serverstring")="full"
	; Listening port
	set conf("listenon","http")=8080
	set conf("listenon","https")=8081
	; Default document name
	set conf("index")="index.html"
	; Error log file
	set conf("errorlog")="$gtm_log/databallet_error.log"
	; Common Log Format file
	set conf("log")="$gtm_log/databallet_access.log"
	; Extended Log Format file
	set conf("extlog")="$gtm_log/databallet_extended.log"
	;
	; Globals configuration
	;
	set TMP="TMPLOCAL" ;2018-02-09 AKB changed TMP, CACHE, and SESSION to locals by removing the ^s; 02-13 appended "LOCAL" to avoid self-reference 
	set CACHE="CACHELOCAL"
	set SESSION="SESSIONLOCAL"
	;
	; Routing configuration
	;
	; Default document root, with static file serving.
	set conf("routing","*","/")="do handle^static(""web/"")" ;2018-02-16 AKB: TODO use $gtmdir/web instead?
        set conf("routing","*","/getmap")="do handle^getmap()"
        set conf("routing","*","/verify")="do handle^verify()"
        set conf("routing","*","/save")="do handle^save()"
EOF

# Setup and create the database if it does not exist
if [ ! -f $gtmgbldir ] ; then
	$gtm_dist/mumps -run GDE >> $log 2>&1 << EOF
change -segment DEFAULT -block_size=4096 -allocation=5000 -noencryption -extension_count=10000 -global_buffer_count=1000 -access_method=MM -lock_space=10 -reserved_bytes=0 -file_name=$gtmdir/gtm.dat
change -region DEFAULT -dynamic_segment=DEFAULT -key_size=255 -record_size=4080 -nojournal -nonull_subscripts
EOF
	#$gtm_dist/mupip create >> $log 2>&1 #AKB 2018-02 we don't want any actions done involving a database which may or may not exist for the global directory being edited
fi
